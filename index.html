<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ad Player</title>
  <style>
    :root{--bg:#000;--fg:#fff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Arial,sans-serif}
    /* STAGE */
    #stage{height:100%;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
    #adImg{max-width:100%;max-height:100%;display:none;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
    /* HUD top-left */
    #hud{position:fixed;top:10px;left:10px;z-index:9999;display:flex;gap:8px;align-items:center;pointer-events:auto}
    #counter{display:none;background:rgba(0,0,0,.6);padding:6px 10px;border-radius:8px;font-size:clamp(16px,4.5vw,24px);font-weight:800}
    #closeBtn{display:none;background:#e11;color:#fff;border:0;padding:6px 10px;border-radius:8px;font-weight:900;cursor:pointer;font-size:18px}
    /* START BUTTON centralissimo (alto z-index, pointer-events ok) */
    #startBtn{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      z-index:2147483647; /* molto alto */
      padding:16px 34px; border-radius:12px; background:#0a8f3c; color:#fff; border:0;
      font-size:22px; cursor:pointer; box-shadow:0 8px 24px rgba(10,143,60,.25);
      -webkit-tap-highlight-color: transparent;
    }
    /* rendilo visibile su mobile */
    @media (max-width:420px){
      #startBtn{padding:14px 28px;font-size:18px}
      #counter{font-size:18px}
      #closeBtn{font-size:16px;padding:6px 8px}
    }
  </style>
</head>
<body>

  <!-- ===== CONFIG: cambia solo questa variabile ===== -->
  <script>const NUM_ADS = 10; /* <<-- metti qui quanti ad potresti avere (es. 700) */</script>
  <!-- ================================================= -->

  <div id="stage">
    <img id="adImg" alt="Annuncio">
  </div>

  <div id="hud">
    <div id="counter">8</div>
    <button id="closeBtn" aria-label="Chiudi annuncio">✕</button>
  </div>

  <button id="startBtn" aria-label="Avvia annuncio">▶ Riproduci</button>

  <audio id="adAudio" playsinline></audio>

<script>
/* minimal, pulito, no logs visibili */
const startBtn = document.getElementById('startBtn');
const adImg = document.getElementById('adImg');
const adAudio = document.getElementById('adAudio');
const counterEl = document.getElementById('counter');
const closeBtn = document.getElementById('closeBtn');

/* helper: prova estensioni per immagine */
function probeImageForIndex(i){
  const exts = ['.png','.jpg','.jpeg'];
  return new Promise((resolve,reject)=>{
    let k = 0;
    function tryOne(){
      if(k >= exts.length){ reject(); return; }
      const url = ad${i}${exts[k]};
      const img = new Image();
      img.onload = ()=> resolve(url);
      img.onerror = ()=> { k++; tryOne(); };
      img.src = url;
    }
    tryOne();
  });
}

/* crea ordine random 1..n */
function shuffledRange(n){
  const a = Array.from({length:n}, (_,i)=>i+1);
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* trova primo ad esistente (prova in ordine random) */
async function findExistingAd(maxAds){
  const order = shuffledRange(Math.max(1, Math.floor(maxAds)));
  for(const idx of order){
    try{
      const url = await probeImageForIndex(idx);
      return {index: idx, imgUrl: url};
    }catch(e){
      // continua
    }
  }
  return null;
}

/* prova ad avviare audio adaudio{n}.mp3 */
function tryPlayAudioForIndex(n){
  return new Promise((resolve)=>{
    const url = adaudio${n}.mp3;
    adAudio.src = url;
    adAudio.load();
    let finished = false;
    function ok(){ if(finished) return; finished = true; resolve(true); }
    function nok(){ if(finished) return; finished = true; resolve(false); }
    adAudio.addEventListener('canplaythrough', ok, {once:true});
    adAudio.addEventListener('error', nok, {once:true});
    setTimeout(()=>{ if(finished) return; if(adAudio.readyState>0){ adAudio.play().catch(()=>{}); finished=true; resolve(true);} else { finished=true; resolve(false); } }, 700);
  });
}

/* start sequence: entra in fullscreen (se possibile), poi mostra ad + audio + timer */
async function startSequence(){
  // richiesta fullscreen (richiede gesture utente)
  try {
    const docEl = document.documentElement;
    if (docEl.requestFullscreen) await docEl.requestFullscreen();
    else if (docEl.webkitRequestFullscreen) docEl.webkitRequestFullscreen(); // iOS-ish (parziale)
    else if (docEl.msRequestFullscreen) docEl.msRequestFullscreen();
  } catch(e) { /* se fallisce, prosegui comunque */ }

  // nascondi start button
  startBtn.style.display = 'none';

  // trova ad esistente
  const found = await findExistingAd(NUM_ADS);
  if(!found){
    // fallback visivo semplice: niente da mostrare
    adImg.style.display = 'none';
    counterEl.style.display = 'none';
    closeBtn.style.display = 'inline-block';
    return;
  }

  adImg.src = found.imgUrl;
  adImg.style.display = 'block';

  // prova audio (se presente)
  tryPlayAudioForIndex(found.index);

  // countdown 8 -> 0
  let t = 8;
  counterEl.textContent = t;
  counterEl.style.display = 'block';
  const id = setInterval(()=>{
    t--;
    counterEl.textContent = t;
    if(t <= 0){
      clearInterval(id);
      counterEl.style.display = 'none';
      closeBtn.style.display = 'inline-block';
    }
  }, 1000);
}

/* listener start: gestisce click/touch/pointer (robusto su mobile) */
function onStart(e){
  if(e.preventDefault) e.preventDefault();
  startSequence();
}
startBtn.addEventListener('click', onStart);
startBtn.addEventListener('pointerdown', onStart);
startBtn.addEventListener('touchstart', onStart, {passive:false});

/* close: prova a uscire dal fullscreen e pulire la pagina */
closeBtn.addEventListener('click', async ()=>{
  try { if(document.fullscreenElement){ await document.exitFullscreen(); } } catch(e){}
  try{ window.close(); }catch(e){}
  // fallback pulito
  document.documentElement.innerHTML = '<body style="background:#000;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh"><h2>Annuncio chiuso ✅</h2></body>';
});

/* fine */
</script>
</body>
</html>
